
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Active Directory LDAP Filter Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>
 * {box-sizing:border-box;}
 body {font-family:Inter,Arial,sans-serif;background:#0f0f0f;color:#e6e6e6;padding:40px 20px;max-width:1400px;margin:auto;line-height:1.6;transition:0.3s;} 
 body.light{background:#fafafa;color:#111;} 
 
 h1{color:#58a6ff;font-size:2.4em;font-weight:700;margin-bottom:0.2em;} 
 h2{color:#58a6ff;font-size:1.4em;margin-bottom:0.5em;}
 h3{color:#79c0ff;font-size:1.1em;margin-top:1em;}
 
 .disclaimer{background:#3d1f1f;border-left:4px solid #f85149;padding:15px;margin-bottom:20px;border-radius:6px;font-size:0.9em;}
 body.light .disclaimer{background:#fff3cd;border-color:#856404;color:#856404;}
 
 .header-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
 
 .themeToggle,.toolBtn{background:#1f1f1f;border:1px solid #333;padding:8px 12px;border-radius:8px;cursor:pointer;font-family:inherit;color:#e6e6e6;} 
 .themeToggle:hover,.toolBtn:hover{background:#2d333b;}
 body.light .themeToggle,body.light .toolBtn{background:#fff;border-color:#ccc;color:#111;}
 body.light .themeToggle:hover,body.light .toolBtn:hover{background:#e6e6e6;}
 
 .card{background:#1b1b1b;padding:25px;border-radius:12px;margin-bottom:30px;border:1px solid #30363d;position:relative;} 
 body.light .card{background:#fff;border-color:#ccc;} 
 
 .tooltip{position:relative;display:inline-block;cursor:help;color:#58a6ff;margin-left:5px;}
 .tooltip:hover::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1f1f1f;color:#e6e6e6;padding:8px 12px;border-radius:6px;white-space:nowrap;z-index:1000;font-size:0.85em;box-shadow:0 4px 12px rgba(0,0,0,0.5);margin-bottom:5px;}
 body.light .tooltip:hover::after{background:#333;color:#fff;}
 
 input,select,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #444;background:#0f0f0f;color:#e6e6e6;margin:8px 0;font-family:inherit;font-size:1em;} 
 body.light input,body.light select,body.light textarea{background:#fff;color:#111;border-color:#ccc;} 
 
 .checkbox-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:10px 0;}
 .checkbox-grid label{display:flex;align-items:center;gap:8px;padding:8px;background:#0c0c0c;border-radius:4px;cursor:pointer;transition:0.2s;}
 .checkbox-grid label:hover{background:#1f1f1f;}
 body.light .checkbox-grid label{background:#f5f5f5;}
 body.light .checkbox-grid label:hover{background:#e6e6e6;}
 .checkbox-grid input[type="checkbox"]{width:auto;margin:0;}
 
 pre{background:#0c0c0c;padding:15px;border-radius:6px;border:1px solid #30363d;font-family:"JetBrains Mono",monospace;overflow-x:auto;font-size:0.85em;line-height:1.5;} 
 body.light pre{background:#f0f0f0;border-color:#ccc;color:#000;} 
 
 .copyBtn,.mode-btn{background:#21262d;border:1px solid #30363d;padding:8px 14px;border-radius:6px;color:#e6e6e6;cursor:pointer;margin:5px 5px 5px 0;font-family:inherit;font-size:0.9em;transition:0.2s;}
 .copyBtn:hover,.mode-btn:hover{background:#2d333b;}
 .mode-btn.active{background:#238636;border-color:#2ea043;}
 body.light .copyBtn,body.light .mode-btn{background:#e6e6e6;color:#111;border-color:#ccc;}
 body.light .copyBtn:hover,body.light .mode-btn:hover{background:#d0d0d0;}
 body.light .mode-btn.active{background:#2da44e;color:#fff;}
 
 .button-group{display:flex;flex-wrap:wrap;gap:0;margin:10px 0;}
 
 .preset-item{background:#0c0c0c;padding:10px;border-radius:6px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;border:1px solid #30363d;}
 body.light .preset-item{background:#f5f5f5;border-color:#ccc;}
 .preset-item button{padding:4px 10px;font-size:0.85em;margin-left:5px;}
 
 .mitre-tag{display:inline-block;background:#3d1f3d;color:#c586c0;padding:2px 8px;border-radius:4px;font-size:0.8em;margin-left:8px;font-family:"JetBrains Mono",monospace;}
 body.light .mitre-tag{background:#e6d9f0;color:#6a1b9a;}
 
 .syntax-error{border:2px solid #f85149 !important;animation:shake 0.3s;}
 @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
 
 .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;justify-content:center;align-items:center;padding:20px;}
 .modal.show{display:flex;}
 .modal-content{background:#1b1b1b;padding:30px;border-radius:12px;max-width:600px;width:100%;max-height:80vh;overflow-y:auto;border:1px solid #30363d;}
 body.light .modal-content{background:#fff;border-color:#ccc;}
 .modal-close{float:right;font-size:1.5em;cursor:pointer;color:#f85149;}
 
 .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0;}
 .stat-box{background:#0c0c0c;padding:15px;border-radius:6px;text-align:center;border:1px solid #30363d;}
 body.light .stat-box{background:#f5f5f5;border-color:#ccc;}
 .stat-number{font-size:2em;font-weight:700;color:#58a6ff;}
 .stat-label{font-size:0.9em;color:#8b949e;margin-top:5px;}
 
 .collapsible{cursor:pointer;user-select:none;}
 .collapsible::before{content:'‚ñº';display:inline-block;margin-right:8px;transition:transform 0.3s;}
 .collapsible.collapsed::before{transform:rotate(-90deg);}
 .collapsible-content{max-height:2000px;overflow:hidden;transition:max-height 0.3s ease;}
 .collapsible-content.hidden{max-height:0;}
 
 @media(max-width:768px){
  body{padding:20px 10px;}
  h1{font-size:1.8em;}
  .checkbox-grid{grid-template-columns:1fr;}
 }
</style>
</head>
<body>

<div class="disclaimer">
 ‚ö†Ô∏è <strong>AUTHORIZED USE ONLY</strong> - This tool is for legitimate penetration testing and security auditing with proper authorization.
</div>

<div class="header-controls">
 <h1>Active Directory LDAP Filter Builder</h1>
 <div>
  <button class="toolBtn" onclick="showModal('presets')">üíæ Presets</button>
  <button class="toolBtn" onclick="showModal('export')">üì§ Export</button>
  <button class="toolBtn" onclick="showModal('help')">‚ùì Help</button>
  <button class="themeToggle" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>
 </div>
</div>

<!-- Domain Input -->
<div class="card">
 <h2>üåê Domain Configuration (Optional)</h2>
 <label>Domain Name (leave empty to auto-detect):</label>
 <input id="domainInput" placeholder="Leave empty for auto-detection or enter: contoso.local" />
 
 <label>Base DN (leave empty for root domain):</label>
 <input id="baseDN" placeholder="Leave empty to query root domain automatically" />
 
 <div style="background:#1a3d1f;border-left:4px solid #3fb950;padding:10px;margin-top:10px;border-radius:6px;font-size:0.85em;">
  ‚ÑπÔ∏è <strong>Tip:</strong> Leave both fields empty - the tool will use your current domain context automatically.
 </div>
</div>

<!-- Quick Modes -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">üéØ Quick Attack Scenarios</h2>
 <div class="collapsible-content">
  <div class="button-group">
   <button class="mode-btn" onclick="applyMode('kerberos')">üé´ Kerberos Attacks</button>
   <button class="mode-btn" onclick="applyMode('delegation')">üîó Delegation</button>
   <button class="mode-btn" onclick="applyMode('shadow')">üëª Shadow Admins</button>
   <button class="mode-btn" onclick="applyMode('persistence')">‚è∞ Persistence</button>
   <button class="mode-btn" onclick="applyMode('infra')">üñ•Ô∏è Infrastructure</button>
   <button class="mode-btn" onclick="applyMode('laps')">üîë LAPS</button>
   <button class="mode-btn" onclick="applyMode('stale')">üìÖ Stale Objects</button>
   <button class="mode-btn" onclick="applyMode('reset')">‚ôªÔ∏è Reset</button>
  </div>
 </div>
</div>

<!-- Base Filter -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">üîç Manual Filter Builder</h2>
 <div class="collapsible-content">
  <label>Attribute:
   <span class="tooltip" data-tip="LDAP attribute to query">‚ÑπÔ∏è</span>
  </label>
  <select id="attribute"></select>
  
  <label>OID Operator:
   <span class="tooltip" data-tip="Matching rule OID - determines how values are compared">‚ÑπÔ∏è</span>
  </label>
  <select id="oid"></select>
  
  <label>Value:</label>
  <input id="valueInput" placeholder="e.g., CN=Users,DC=example,DC=local or specific value" />
  
  <label>
   <input type="checkbox" id="useNOT" style="width:auto;margin-right:8px;">
   Use NOT operator (exclude matches)
  </label>
 </div>
</div>

<!-- UAC Flags -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">üîê User Account Control (UAC) Flags</h2>
 <div class="collapsible-content">
  <div class="checkbox-grid" id="uacGrid"></div>
  <label>Decimal Sum:
   <span class="tooltip" data-tip="Combined UAC flag value - use this for manual queries">‚ÑπÔ∏è</span>
  </label>
  <input id="uacSum" readonly style="background:#0c0c0c;cursor:not-allowed;" />
 </div>
</div>

<!-- Admin Groups -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">üëë Administrative Group Membership</h2>
 <div class="collapsible-content">
  <label>Search for members of (includes nested):
   <span class="tooltip" data-tip="Uses LDAP_MATCHING_RULE_IN_CHAIN (1941) for recursive search">‚ÑπÔ∏è</span>
  </label>
  <select id="adminGroup">
   <option value="">-- None --</option>
  </select>
 </div>
</div>

<!-- Advanced Enumeration -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">‚ö° Advanced Enumeration Modules</h2>
 <div class="collapsible-content">
  <div class="checkbox-grid" id="advancedModules"></div>
 </div>
</div>

<!-- Time-Based Filters -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">‚è±Ô∏è Time-Based Filters</h2>
 <div class="collapsible-content">
  <label>Last Logon (days ago):</label>
  <input type="number" id="lastLogonDays" placeholder="e.g., 90" min="0" />
  
  <label>Password Last Set (days ago):</label>
  <input type="number" id="pwdLastSetDays" placeholder="e.g., 180" min="0" />
  
  <label>Account Created (days ago):</label>
  <input type="number" id="whenCreatedDays" placeholder="e.g., 30" min="0" />
 </div>
</div>

<!-- Syntax Validation -->
<div class="card">
 <h2>‚úì Syntax Validation & Debugging</h2>
 <div class="stats">
  <div class="stat-box">
   <div class="stat-number" id="filterComplexity">0</div>
   <div class="stat-label">Complexity</div>
  </div>
  <div class="stat-box">
   <div class="stat-number" id="filterDepth">0</div>
   <div class="stat-label">Nesting Depth</div>
  </div>
  <div class="stat-box">
   <div class="stat-number" id="syntaxStatus">‚úì</div>
   <div class="stat-label">Syntax</div>
  </div>
 </div>
 <div id="validationMessages"></div>
 
 <h3 style="margin-top:20px;">üß™ Test with Known-Good Filters:</h3>
 <div style="background:#0c0c0c;padding:15px;border-radius:6px;margin:10px 0;">
  <button class="copyBtn" onclick="testFilter('all')">All Objects (objectClass=*)</button>
  <button class="copyBtn" onclick="testFilter('users')">All Users</button>
  <button class="copyBtn" onclick="testFilter('computers')">All Computers</button>
  <button class="copyBtn" onclick="testFilter('admins')">Admin Count=1</button>
  <button class="copyBtn" onclick="testFilter('enabled')">Enabled Accounts</button>
 </div>
 
 <div id="debugInfo" style="background:#1a1a1a;padding:10px;border-radius:6px;font-family:monospace;font-size:0.85em;margin-top:10px;"></div>
</div>

<!-- Generated Filter -->
<div class="card">
 <h2>üìã Generated LDAP Filter</h2>
 <button class="copyBtn" onclick="copyOut('ldapOut')">üìã Copy Filter</button>
 <button class="copyBtn" onclick="savePreset()">üíæ Save as Preset</button>
 <pre id="ldapOut"></pre>
</div>

<!-- Command Outputs -->
<div class="card">
 <h2 class="collapsible" onclick="toggleCollapse(this)">üíª Ready-to-Use Commands</h2>
 <div class="collapsible-content">
  <h3>dsquery </h3>
  <button class="copyBtn" onclick="copyOut('dsq')">üìã Copy</button>
  <pre id="dsq"></pre>
  
  <h3>PowerShell (Get-ADObject)</h3>
  <button class="copyBtn" onclick="copyOut('ps')">üìã Copy</button>
  <pre id="ps"></pre>
  
  <h3>ldapsearch (Linux)</h3>
  <button class="copyBtn" onclick="copyOut('ldap')">üìã Copy</button>
  <pre id="ldap"></pre>
  
  <h3>SharpView</h3>
  <button class="copyBtn" onclick="copyOut('sharp')">üìã Copy</button>
  <pre id="sharp"></pre>
  
  <h3>BloodHound Cypher Query</h3>
  <button class="copyBtn" onclick="copyOut('cypher')">üìã Copy</button>
  <pre id="cypher"></pre>
 </div>
</div>

<!-- Modals -->
<div id="presetsModal" class="modal">
 <div class="modal-content">
  <span class="modal-close" onclick="closeModal('presets')">&times;</span>
  <h2>üíæ Saved Presets</h2>
  <div id="presetsList"></div>
 </div>
</div>

<div id="exportModal" class="modal">
 <div class="modal-content">
  <span class="modal-close" onclick="closeModal('export')">&times;</span>
  <h2>üì§ Export Configuration</h2>
  <button class="copyBtn" onclick="exportConfig()">Download JSON</button>
  <h3>Import Configuration:</h3>
  <textarea id="importArea" rows="10" placeholder="Paste exported JSON here..."></textarea>
  <button class="copyBtn" onclick="importConfig()">Import</button>
 </div>
</div>

<div id="helpModal" class="modal">
 <div class="modal-content">
  <span class="modal-close" onclick="closeModal('help')">&times;</span>
  <h2>‚ùì Quick Reference</h2>
  <h3>OID Operators:</h3>
  <ul>
   <li><strong>1.2.840.113556.1.4.803</strong> - Bitwise AND: All specified bits must be set</li>
   <li><strong>1.2.840.113556.1.4.804</strong> - Bitwise OR: Any specified bit must be set</li>
   <li><strong>1.2.840.113556.1.4.1941</strong> - In-Chain: Recursive/nested group membership</li>
  </ul>
  <h3>Common UAC Values:</h3>
  <ul>
   <li><strong>512</strong> - Normal user account</li>
   <li><strong>4194304</strong> - AS-REP roastable (no Kerberos preauth)</li>
   <li><strong>524288</strong> - Trusted for unconstrained delegation</li>
   <li><strong>65536</strong> - Password never expires</li>
  </ul>
  <h3>Attack Techniques:</h3>
  <ul>
   <li><strong>Kerberoasting</strong> - Target accounts with SPNs</li>
   <li><strong>AS-REP Roasting</strong> - Accounts without preauth required</li>
   <li><strong>Delegation Abuse</strong> - Unconstrained/constrained delegation</li>
   <li><strong>LAPS</strong> - Local admin password readers</li>
  </ul>
 </div>
</div>

<script>
//------------------------------------------------------------
// STATE MANAGEMENT
//------------------------------------------------------------
let activeMode = null;
let presets = [];

//------------------------------------------------------------
// THEME
//------------------------------------------------------------
function toggleTheme(){
 document.body.classList.toggle('light');
 localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
}

if(localStorage.getItem('theme') === 'light'){
 document.body.classList.add('light');
}

//------------------------------------------------------------
// COLLAPSIBLE SECTIONS
//------------------------------------------------------------
function toggleCollapse(elem){
 elem.classList.toggle('collapsed');
 const content = elem.nextElementSibling;
 content.classList.toggle('hidden');
}

//------------------------------------------------------------
// MODAL MANAGEMENT
//------------------------------------------------------------
function showModal(type){
 if(type === 'presets') loadPresets();
 document.getElementById(type + 'Modal').classList.add('show');
}

function closeModal(type){
 document.getElementById(type + 'Modal').classList.remove('show');
}

//------------------------------------------------------------
// UTILITIES
//------------------------------------------------------------
function domainToDC(domain){
 if(!domain) return '';
 if(!domain.includes('.')){
  // Single word domain like "CONTOSO"
  return `DC=${domain}`;
 }
 return domain.split('.').map(p=>`DC=${p}`).join(',');
}

function autoDetectDomain(){
 // Show PowerShell command to get domain
 const cmd = `$env:USERDNSDOMAIN`;
 alert(`To auto-detect your domain, run this in PowerShell:\n\n${cmd}\n\nOr run:\n(Get-ADDomain).DNSRoot\n\nThen paste the result in the Domain Name field.`);
 
 // Try to suggest based on common patterns
 const suggestion = prompt('Enter your computer/domain name (e.g., WORKSTATION01 or CONTOSO):');
 if(suggestion){
  const cleaned = suggestion.toLowerCase().replace(/[^a-z0-9-]/g, '');
  const guessed = `${cleaned}.local`;
  if(confirm(`Use "${guessed}" as domain?`)){
   document.getElementById('domainInput').value = guessed;
   updateAll();
  }
 }
}

function fileTimeFromDaysAgo(days){
 const now = new Date();
 const past = new Date(now - (days * 24 * 60 * 60 * 1000));
 const epoch = new Date('1601-01-01T00:00:00Z');
 const ticks = (past - epoch) * 10000;
 return ticks.toString();
}

//------------------------------------------------------------
// DATA MODELS
//------------------------------------------------------------
const ATTRIBUTES=[
 'userAccountControl','memberOf','servicePrincipalName','sAMAccountName',
 'objectClass','adminCount','description','cn','distinguishedName',
 'pwdLastSet','lastLogon','lastLogonTimestamp','whenCreated','primaryGroupID',
 'msDS-AllowedToActOnBehalfOfOtherIdentity','msDS-AllowedToDelegateTo',
 'ms-Mcs-AdmPwd','sIDHistory','mail','userPrincipalName'
];

const OIDS=[
 {id:'1.2.840.113556.1.4.803',label:'Bitwise AND (803) - All bits must match',desc:'Use for UAC flags where ALL specified bits must be set'},
 {id:'1.2.840.113556.1.4.804',label:'Bitwise OR (804) - Any bit matches',desc:'Use for UAC flags where ANY specified bit can be set'},
 {id:'1.2.840.113556.1.4.1941',label:'In-Chain (1941) - Nested groups',desc:'Recursive search through group memberships'}
];

const UAC_FLAGS=[
 {label:'Disabled',value:2,desc:'Account is disabled'},
 {label:'Pwd Not Required',value:32,desc:'No password required'},
 {label:'Normal Account',value:512,desc:'Standard user account'},
 {label:'Pwd Never Expires',value:65536,desc:'Password never expires - persistence risk',mitre:'T1078.002'},
 {label:'No Preauth Required (AS-REP)',value:4194304,desc:'AS-REP roastable - no Kerberos preauth',mitre:'T1558.004'},
 {label:'Unconstrained Delegation',value:524288,desc:'Can impersonate any user - high risk',mitre:'T1484'},
 {label:'Password Expired',value:8388608,desc:'Password has expired'},
 {label:'Smartcard Required',value:262144,desc:'Smartcard authentication required'}
];

const ADMIN_GROUPS=[
 'CN=Domain Admins','CN=Enterprise Admins','CN=Administrators',
 'CN=Schema Admins','CN=Account Operators','CN=Backup Operators',
 'CN=Print Operators','CN=Server Operators','CN=DnsAdmins'
];

const ADVANCED=[
 {key:'kerbUser',label:'Kerberoastable Users',filter:'(&(servicePrincipalName=*)(!(objectClass=computer))(!(userAccountControl:1.2.840.113556.1.4.803:=2)))',mitre:'T1558.003',desc:'Users with SPNs - vulnerable to Kerberoasting'},
 {key:'asrep',label:'AS-REP Roastable',filter:'(userAccountControl:1.2.840.113556.1.4.803:=4194304)',mitre:'T1558.004',desc:'No preauth required - can request TGT without password'},
 {key:'delegComp',label:'Unconstrained Delegation (Computers)',filter:'(&(objectClass=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288)(!(primaryGroupID=516)))',mitre:'T1484',desc:'Computers trusted for delegation - can impersonate users'},
 {key:'delegUser',label:'Unconstrained Delegation (Users)',filter:'(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=524288))',mitre:'T1484',desc:'Users trusted for delegation'},
 {key:'constrained',label:'Constrained Delegation',filter:'(msDS-AllowedToDelegateTo=*)',mitre:'T1484',desc:'Can delegate to specific services'},
 {key:'rbcd',label:'Resource-Based Constrained Delegation',filter:'(msDS-AllowedToActOnBehalfOfOtherIdentity=*)',mitre:'T1484',desc:'RBCD targets - can be exploited for privilege escalation'},
 {key:'adminCount',label:'AdminCount=1 (Protected)',filter:'(adminCount=1)',mitre:'T1087.002',desc:'Current or former privileged accounts'},
 {key:'noExpiry',label:'Password Never Expires',filter:'(userAccountControl:1.2.840.113556.1.4.803:=65536)',mitre:'T1078.002',desc:'Persistence mechanism'},
 {key:'spn',label:'Has SPN',filter:'(servicePrincipalName=*)',mitre:'T1558.003',desc:'Service accounts - potential Kerberoasting targets'},
 {key:'disabled',label:'Disabled Accounts',filter:'(userAccountControl:1.2.840.113556.1.4.803:=2)',mitre:'T1087.002',desc:'Inactive accounts'},
 {key:'lapsRead',label:'LAPS Password Readers',filter:'(ms-Mcs-AdmPwd=*)',mitre:'T1003',desc:'Can read local admin passwords'},
 {key:'sidHistory',label:'SID History Present',filter:'(sIDHistory=*)',mitre:'T1134.005',desc:'Potential persistence or privilege escalation'},
 {key:'preWindows2000',label:'Pre-Windows 2000 Compatible Access',filter:'(primaryGroupID=554)',mitre:'T1087.002',desc:'Legacy group - often overprivileged'},
 {key:'dnsAdmins',label:'DNS Admins',filter:'(memberOf:1.2.840.113556.1.4.1941:=CN=DnsAdmins,CN=Users)',mitre:'T1484',desc:'Can load DLLs on DC via DNS'}
];

//------------------------------------------------------------
// UI INITIALIZATION
//------------------------------------------------------------
function initUI(){
 const a=document.getElementById('attribute');
 ATTRIBUTES.forEach(v=>a.innerHTML+=`<option>${v}</option>`);

 const o=document.getElementById('oid');
 OIDS.forEach(v=>o.innerHTML+=`<option value="${v.id}" title="${v.desc}">${v.label}</option>`);

 const ug=document.getElementById('uacGrid');
 UAC_FLAGS.forEach(f=>{
  const mitre = f.mitre ? `<span class="mitre-tag">${f.mitre}</span>` : '';
  ug.innerHTML+=`<label title="${f.desc}"><input type='checkbox' class='uac' value='${f.value}'> ${f.label}${mitre}</label>`;
 });

 const ag=document.getElementById('adminGroup');
 ADMIN_GROUPS.forEach(g=>ag.innerHTML+=`<option>${g}</option>`);

 const adv=document.getElementById('advancedModules');
 ADVANCED.forEach(m=>{
  const mitre = m.mitre ? `<span class="mitre-tag">${m.mitre}</span>` : '';
  adv.innerHTML+=`<label title="${m.desc}"><input type='checkbox' class='adv' data-key='${m.key}' data-filter='${m.filter}'> ${m.label}${mitre}</label>`;
 });

 document.querySelectorAll('input,select,textarea').forEach(e=>e.addEventListener('input',updateAll));
 document.querySelectorAll('.uac').forEach(e=>e.addEventListener('change',updateUACSum));
 
document.getElementById('domainInput').addEventListener('input', ()=>{
 const domain = document.getElementById('domainInput').value.trim();
 const dc = domainToDC(domain);
 document.getElementById('baseDN').value = dc || 'DC=example,DC=local';
});
 
 loadPresetsFromStorage();
}

//------------------------------------------------------------
// UAC SUM CALCULATOR
//------------------------------------------------------------
function updateUACSum(){
 const sum = [...document.querySelectorAll('.uac:checked')]
   .map(x=>parseInt(x.value))
   .reduce((a,b)=>a+b,0);
 document.getElementById('uacSum').value = sum > 0 ? sum : '';
 updateAll();
}

//------------------------------------------------------------
// FILTER GENERATION
//------------------------------------------------------------
function buildFilter(){
 const attr=document.getElementById('attribute').value;
 const oid=document.getElementById('oid').value;
 const val=document.getElementById('valueInput').value.trim();
 const useNOT=document.getElementById('useNOT').checked;

 let parts = [];

 // UAC bitmask (check this FIRST)
 const sum = [...document.querySelectorAll('.uac:checked')]
   .map(x=>parseInt(x.value))
   .reduce((a,b)=>a+b,0);
 
 if(sum > 0){
  parts.push(`(userAccountControl:1.2.840.113556.1.4.803:=${sum})`);
 } else if(val){
  // Only use manual input if no UAC flags selected
  // Check if it's a simple attribute=value query (no OID needed)
  if(val.includes('=') || val.includes('*')){
   // Direct filter like "cn=*" or "objectClass=user"
   let filter = `(${attr}=${val})`;
   if(useNOT) filter = `(!${filter})`;
   parts.push(filter);
  } else {
   // Use OID matching
   let filter = `(${attr}:${oid}:=${val})`;
   if(useNOT) filter = `(!${filter})`;
   parts.push(filter);
  }
 }

 // Admin group membership (nested)
 const domain=document.getElementById('domainInput').value.trim();
 const baseDN=document.getElementById('baseDN').value.trim();
 const dc=baseDN || domainToDC(domain);
 const ag=document.getElementById('adminGroup').value;
 
 if(ag && dc){
  parts.push(`(memberOf:1.2.840.113556.1.4.1941:=${ag},${dc})`);
 }

 // Advanced module filters
 const advFilters = [...document.querySelectorAll('.adv:checked')]
   .map(x=>x.dataset.filter);
 
 parts.push(...advFilters);

 // Time-based filters
 const lastLogonDays = document.getElementById('lastLogonDays').value;
 const pwdLastSetDays = document.getElementById('pwdLastSetDays').value;
 const whenCreatedDays = document.getElementById('whenCreatedDays').value;
 
 if(lastLogonDays){
  const time = fileTimeFromDaysAgo(parseInt(lastLogonDays));
  parts.push(`(lastLogonTimestamp<=${time})`);
 }
 if(pwdLastSetDays){
  const time = fileTimeFromDaysAgo(parseInt(pwdLastSetDays));
  parts.push(`(pwdLastSet<=${time})`);
 }
 if(whenCreatedDays){
  const time = fileTimeFromDaysAgo(parseInt(whenCreatedDays));
  parts.push(`(whenCreated>=${time})`);
 }

 // Build final filter with proper logic
 if(parts.length === 0){
  return '(objectClass=*)';
 }
 if(parts.length === 1){
  return parts[0];
 }
 
 // Multiple conditions - use AND
 return `(&${parts.join('')})`;
}

//------------------------------------------------------------
// FILTER VALIDATION
//------------------------------------------------------------
function validateFilter(filter){
 const errors = [];
 let openCount = 0;
 let closeCount = 0;
 
 for(let char of filter){
  if(char === '(') openCount++;
  if(char === ')') closeCount++;
 }
 
 if(openCount !== closeCount){
  errors.push('Mismatched parentheses');
 }
 
 if(!filter.startsWith('(')){
  errors.push('Filter must start with (');
 }
 
 if(!filter.endsWith(')')){
  errors.push('Filter must end with )');
 }
 
 // Calculate complexity
 const complexity = openCount;
 const depth = calculateDepth(filter);
 
 return {valid: errors.length === 0, errors, complexity, depth};
}

function calculateDepth(filter){
 let maxDepth = 0;
 let currentDepth = 0;
 
 for(let char of filter){
  if(char === '('){
   currentDepth++;
   maxDepth = Math.max(maxDepth, currentDepth);
  }
  if(char === ')') currentDepth--;
 }
 
 return maxDepth;
}

//------------------------------------------------------------
// OUTPUTS
//------------------------------------------------------------
function updateAll(){
 const f=buildFilter();
 const validation = validateFilter(f);
 
 // Update filter output
 const ldapOut = document.getElementById('ldapOut');
 ldapOut.textContent=f;
 
 if(!validation.valid){
  ldapOut.classList.add('syntax-error');
 } else {
  ldapOut.classList.remove('syntax-error');
 }
 
 // Update stats
 document.getElementById('filterComplexity').textContent = validation.complexity;
 document.getElementById('filterDepth').textContent = validation.depth;
 document.getElementById('syntaxStatus').textContent = validation.valid ? '‚úì' : '‚úó';
 document.getElementById('syntaxStatus').style.color = validation.valid ? '#3fb950' : '#f85149';
 
 // Validation messages
 const msgDiv = document.getElementById('validationMessages');
 if(validation.errors.length > 0){
  msgDiv.innerHTML = validation.errors.map(e=>`<div style="color:#f85149;margin-top:5px;">‚ö†Ô∏è ${e}</div>`).join('');
 } else {
  msgDiv.innerHTML = '<div style="color:#3fb950;margin-top:5px;">‚úì Valid LDAP syntax</div>';
 }
 
 // Debug info
 const debugDiv = document.getElementById('debugInfo');
 const checkedUAC = [...document.querySelectorAll('.uac:checked')].map(x=>x.value);
 const checkedAdv = [...document.querySelectorAll('.adv:checked')].map(x=>x.dataset.key);
 debugDiv.innerHTML = `
  <strong>Debug Info:</strong><br>
  Manual Value: "${document.getElementById('valueInput').value}"<br>
  UAC Flags: [${checkedUAC.join(', ') || 'none'}]<br>
  Advanced: [${checkedAdv.join(', ') || 'none'}]<br>
  Filter Length: ${f.length} chars<br>
  Parentheses: ${(f.match(/\(/g) || []).length} open, ${(f.match(/\)/g) || []).length} close
 `;
 
 const domain=document.getElementById('domainInput').value.trim();
 const baseDN=document.getElementById('baseDN').value.trim();
 const dc=baseDN || domainToDC(domain) || 'DC=example,DC=local';
 const dcHost = domain || 'dc.example.local';
 
 // Generate commands
 document.getElementById('dsq').textContent=`dsquery * "${dc}" -filter "${f}" -limit 0 -attr *`;
 document.getElementById('ps').textContent=`Get-ADObject -LDAPFilter "${f}" -SearchBase "${dc}" -Properties * | Select-Object Name,DistinguishedName,ObjectClass`;
 document.getElementById('ldap').textContent=`ldapsearch -x -H ldap://${dcHost} -b "${dc}" "${f}" -LLL`;
 document.getElementById('sharp').textContent=`SharpView.exe Get-DomainObject -LDAPFilter "${f}" -Domain ${domain || 'example.local'}`;
 
 // BloodHound Cypher (simplified mapping)
 let cypherQuery = generateCypherQuery(f);
 document.getElementById('cypher').textContent=cypherQuery;
}

function generateCypherQuery(filter){
 // Basic mapping of common LDAP filters to Cypher
 if(filter.includes('adminCount=1')){
  return 'MATCH (u:User {admincount: true}) RETURN u.name, u.enabled';
 }
 if(filter.includes('servicePrincipalName=*')){
  return 'MATCH (u:User) WHERE u.hasspn=true RETURN u.name, u.serviceprincipalnames';
 }
 if(filter.includes('4194304')){
  return 'MATCH (u:User {dontreqpreauth: true}) RETURN u.name';
 }
 if(filter.includes('524288')){
  return 'MATCH (c:Computer) WHERE c.unconstraineddelegation=true RETURN c.name';
 }
 if(filter.includes('Domain Admins')){
  return 'MATCH p=(u:User)-[:MemberOf*1..]->(g:Group {name:"DOMAIN ADMINS@EXAMPLE.LOCAL"}) RETURN p';
 }
 
 return '// Custom LDAP filter - manual Cypher conversion needed\n// Consider using: MATCH (n) WHERE ... RETURN n';
}

//------------------------------------------------------------
// MODES
//------------------------------------------------------------
function applyMode(mode){
 // Clear all advanced checkboxes
 document.querySelectorAll('.adv').forEach(x=>x.checked=false);
 document.querySelectorAll('.uac').forEach(x=>x.checked=false);
 document.getElementById('lastLogonDays').value = '';
 document.getElementById('pwdLastSetDays').value = '';
 document.getElementById('whenCreatedDays').value = '';
 
 // Remove active class from all buttons
 document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
 
 if(mode === 'reset'){
  activeMode = null;
  document.getElementById('valueInput').value = '';
  document.getElementById('adminGroup').value = '';
  document.getElementById('useNOT').checked = false;
  updateAll();
  return;
 }
 
 // Set active button
 event.target.classList.add('active');
 activeMode = mode;
 
 switch(mode){
  case 'kerberos':
   checkKeys(['kerbUser','asrep']);
   break;
  case 'delegation':
   checkKeys(['delegComp','delegUser','constrained','rbcd']);
   break;
  case 'shadow':
   checkKeys(['adminCount','spn','sidHistory']);
   break;
  case 'persistence':
   checkKeys(['noExpiry','disabled','sidHistory']);
   break;
  case 'infra':
   document.getElementById('attribute').value = 'objectClass';
   document.getElementById('valueInput').value = 'computer';
   break;
  case 'laps':
   checkKeys(['lapsRead']);
   document.getElementById('adminGroup').value = 'CN=Domain Admins';
   break;
  case 'stale':
   document.getElementById('lastLogonDays').value = '90';
   document.getElementById('pwdLastSetDays').value = '180';
   break;
 }
 
 updateAll();
}

function checkKeys(keys){
 document.querySelectorAll('.adv').forEach(x=>{
  if(keys.includes(x.dataset.key)){
   x.checked = true;
  }
 });
}

//------------------------------------------------------------
// PRESETS
//------------------------------------------------------------
function savePreset(){
 const name = prompt('Enter preset name:');
 if(!name) return;
 
 const config = {
  name: name,
  timestamp: new Date().toISOString(),
  domain: document.getElementById('domainInput').value,
  baseDN: document.getElementById('baseDN').value,
  attribute: document.getElementById('attribute').value,
  oid: document.getElementById('oid').value,
  value: document.getElementById('valueInput').value,
  useNOT: document.getElementById('useNOT').checked,
  uacFlags: [...document.querySelectorAll('.uac:checked')].map(x=>x.value),
  adminGroup: document.getElementById('adminGroup').value,
  advancedModules: [...document.querySelectorAll('.adv:checked')].map(x=>x.dataset.key),
  lastLogonDays: document.getElementById('lastLogonDays').value,
  pwdLastSetDays: document.getElementById('pwdLastSetDays').value,
  whenCreatedDays: document.getElementById('whenCreatedDays').value,
  filter: buildFilter()
 };
 
 presets.push(config);
 localStorage.setItem('ldapPresets', JSON.stringify(presets));
 alert('Preset saved!');
}

function loadPresetsFromStorage(){
 const stored = localStorage.getItem('ldapPresets');
 if(stored){
  presets = JSON.parse(stored);
 }
}

function loadPresets(){
 const list = document.getElementById('presetsList');
 list.innerHTML = '';
 
 if(presets.length === 0){
  list.innerHTML = '<p>No saved presets yet. Use "Save as Preset" to create one.</p>';
  return;
 }
 
 presets.forEach((preset, idx)=>{
  const item = document.createElement('div');
  item.className = 'preset-item';
  item.innerHTML = `
   <div>
    <strong>${preset.name}</strong><br>
    <small>${new Date(preset.timestamp).toLocaleString()}</small><br>
    <code style="font-size:0.8em;">${preset.filter.substring(0,80)}...</code>
   </div>
   <div>
    <button class="copyBtn" onclick="loadPreset(${idx})">Load</button>
    <button class="copyBtn" onclick="deletePreset(${idx})">Delete</button>
   </div>
  `;
  list.appendChild(item);
 });
}

function loadPreset(idx){
 const preset = presets[idx];
 
 document.getElementById('domainInput').value = preset.domain || '';
 document.getElementById('baseDN').value = preset.baseDN || '';
 document.getElementById('attribute').value = preset.attribute || 'userAccountControl';
 document.getElementById('oid').value = preset.oid || '1.2.840.113556.1.4.803';
 document.getElementById('valueInput').value = preset.value || '';
 document.getElementById('useNOT').checked = preset.useNOT || false;
 document.getElementById('adminGroup').value = preset.adminGroup || '';
 document.getElementById('lastLogonDays').value = preset.lastLogonDays || '';
 document.getElementById('pwdLastSetDays').value = preset.pwdLastSetDays || '';
 document.getElementById('whenCreatedDays').value = preset.whenCreatedDays || '';
 
 // Clear and set UAC flags
 document.querySelectorAll('.uac').forEach(x=>x.checked=false);
 if(preset.uacFlags){
  preset.uacFlags.forEach(val=>{
   const checkbox = document.querySelector(`.uac[value="${val}"]`);
   if(checkbox) checkbox.checked = true;
  });
 }
 
 // Clear and set advanced modules
 document.querySelectorAll('.adv').forEach(x=>x.checked=false);
 if(preset.advancedModules){
  preset.advancedModules.forEach(key=>{
   const checkbox = document.querySelector(`.adv[data-key="${key}"]`);
   if(checkbox) checkbox.checked = true;
  });
 }
 
 updateUACSum();
 updateAll();
 closeModal('presets');
}

function deletePreset(idx){
 if(confirm('Delete this preset?')){
  presets.splice(idx, 1);
  localStorage.setItem('ldapPresets', JSON.stringify(presets));
  loadPresets();
 }
}

//------------------------------------------------------------
// EXPORT/IMPORT
//------------------------------------------------------------
function exportConfig(){
 const config = {
  version: '1.0',
  exported: new Date().toISOString(),
  presets: presets,
  current: {
   domain: document.getElementById('domainInput').value,
   baseDN: document.getElementById('baseDN').value,
   attribute: document.getElementById('attribute').value,
   oid: document.getElementById('oid').value,
   value: document.getElementById('valueInput').value,
   filter: buildFilter()
  }
 };
 
 const json = JSON.stringify(config, null, 2);
 const blob = new Blob([json], {type: 'application/json'});
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `ldap-filters-${Date.now()}.json`;
 a.click();
 URL.revokeObjectURL(url);
}

function importConfig(){
 try {
  const json = document.getElementById('importArea').value;
  const config = JSON.parse(json);
  
  if(config.presets){
   presets = config.presets;
   localStorage.setItem('ldapPresets', JSON.stringify(presets));
  }
  
  alert('Configuration imported successfully!');
  document.getElementById('importArea').value = '';
  closeModal('export');
 } catch(e) {
  alert('Invalid JSON: ' + e.message);
 }
}

//------------------------------------------------------------
// COPY FUNCTIONALITY
//------------------------------------------------------------
function copyOut(id){
 const text = document.getElementById(id).textContent;
 navigator.clipboard.writeText(text).then(()=>{
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = '‚úì Copied!';
  setTimeout(()=>btn.textContent = orig, 2000);
 });
}

//------------------------------------------------------------
// TEST FILTERS
//------------------------------------------------------------
function testFilter(type){
 // Clear everything first
 document.querySelectorAll('.adv').forEach(x=>x.checked=false);
 document.querySelectorAll('.uac').forEach(x=>x.checked=false);
 document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
 document.getElementById('valueInput').value = '';
 document.getElementById('adminGroup').value = '';
 document.getElementById('lastLogonDays').value = '';
 document.getElementById('pwdLastSetDays').value = '';
 document.getElementById('whenCreatedDays').value = '';
 document.getElementById('useNOT').checked = false;
 
 // Set attribute to objectClass for most tests
 document.getElementById('attribute').value = 'objectClass';
 
 switch(type){
  case 'all':
   // Return all objects - this MUST work
   document.getElementById('valueInput').value = '*';
   break;
  case 'users':
   // All user objects
   document.getElementById('valueInput').value = 'user';
   break;
  case 'computers':
   // All computer objects
   document.getElementById('valueInput').value = 'computer';
   break;
  case 'admins':
   // Users with adminCount=1
   document.getElementById('attribute').value = 'adminCount';
   document.getElementById('valueInput').value = '1';
   break;
  case 'enabled':
   // NOT disabled - this tests NOT logic
   const disabledCheckbox = document.querySelector('.uac[value="2"]');
   if(disabledCheckbox){
    disabledCheckbox.checked = true;
   }
   document.getElementById('useNOT').checked = true;
   break;
 }
 
 updateUACSum();
 updateAll();
 
 // Show which test was loaded
 alert(`Test filter loaded: ${type}\n\nCheck the generated filter and try running the dsquery or PowerShell command.`);
}

//------------------------------------------------------------
// KEYBOARD SHORTCUTS
//------------------------------------------------------------
document.addEventListener('keydown', (e)=>{
 // Ctrl/Cmd + S to save preset
 if((e.ctrlKey || e.metaKey) && e.key === 's'){
  e.preventDefault();
  savePreset();
 }
 // Ctrl/Cmd + E to export
 if((e.ctrlKey || e.metaKey) && e.key === 'e'){
  e.preventDefault();
  showModal('export');
 }
});

//------------------------------------------------------------
// INITIALIZATION
//------------------------------------------------------------
initUI(); 
updateAll();

console.log('%cüîç AD LDAP Filter Builder Pro', 'font-size:20px;color:#58a6ff;font-weight:bold;');
console.log('%cKeyboard shortcuts:', 'font-weight:bold;margin-top:10px;');
console.log('  Ctrl/Cmd + S: Save preset');
console.log('  Ctrl/Cmd + E: Export config');
console.log('%c‚ö†Ô∏è Use responsibly and with authorization only!', 'color:#f85149;font-weight:bold;margin-top:10px;');
</script>
 <footer style="text-align: center; padding: 20px; margin-top: 40px; color: #666; font-size: 0.85em;">
  Created by dv-smith AKA p4ck3th0rse
</footer>
</body>
 
</html>
